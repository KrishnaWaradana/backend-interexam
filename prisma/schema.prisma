generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}


enum Role {
  Validator
  Contributor
  Admin
}

enum JenisSoal {
  short_answer    @map("short answer")
  multiple_choice @map("multiple choice")
  multiple_answer @map("multiple answer")
  true_false      @map("true false")
}

enum LevelKesulitan {
  mudah
  sedang
  sulit
}

enum StatusSoal {
  draft
  need_verification @map("need verification")
  disetujui
  ditolak
}

enum StatusValidasi {
  ditolak
  disetujui
}

enum JenisPaket {
  gratis
  berbayar
}

enum StatusPaket {
  draft
  active
  inactive
}

enum NamaPeriode {
  hari
  minggu
  bulan
  tahun
}

enum StatusSubscribe {
  active
  inactive
}

enum UserStatusEnum {
  Verified
  Unverified
  Suspend
}

enum StatusEvent {
  active
  inactive
  draft
}

enum JenisEvent {
  Gratis
  Berbayar
}

model Categories {
  id_category   Int     @id @default(autoincrement())
  nama_category String? @db.VarChar(45)
  keterangan    String? @db.VarChar(45)

  categorySubject CategorySubject[]
  paketSoal       PaketSoal[]
  paketLangganan  PaketLangganan[]
  categoryTopics  CategoryTopics[]
  events          Event[]

  @@map("categories")
}

model Subjects {
  id_subject      Int               @id @default(autoincrement()) @map("id_subject")
  nama_subject    String?           @db.VarChar(45)
  keterangan      String?           @db.VarChar(45)
  id_user         Int?
  creator         Users?            @relation("UserSubjects", fields: [id_user], references: [id_user])
  topics          Topics[]
  categorySubject CategorySubject[]
  userKompetensi  KompetensiUser[]

  @@map("subjects")
}

model Users {
  id_user    Int     @id @default(autoincrement())
  username   String? @db.VarChar(45)
  password   String? @db.VarChar(100)
  role       Role?
  nama_user  String? @db.VarChar(45)
  email_user String? @unique @db.VarChar(45)
  phone      String? @db.VarChar(45)
  googleId   String? @unique @db.VarChar(255)
  foto       String? @db.VarChar(255)
  status     UserStatusEnum? @default(Unverified)

  subjectsCreated  Subjects[]  @relation("UserSubjects")
  topicsCreated    Topics[]    @relation("UserTopics")
  subTopicsCreated SubTopics[] @relation("UserSubTopics")
  jenjangCreated   Jenjang[]   @relation("UserJenjang")
  soalCreated      Soal[]      @relation("UserSoal")
  validasiSoal     ValidasiSoal[]
  paketCreated     PaketSoal[]
  statusUser       UserStatus[] @relation("UserOwner")
  statusAdmin      UserStatus[] @relation("AdminModifier")
  kompetensi       KompetensiUser[]
  notifReceived    SystemNotification[] @relation("NotifRecipient")
  notifSent        SystemNotification[] @relation("NotifSender")

  @@map("users")
}

model KompetensiUser {
  id_user    Int
  id_subject Int
  user       Users    @relation(fields: [id_user], references: [id_user])
  subject    Subjects @relation(fields: [id_subject], references: [id_subject])

  @@id([id_user, id_subject])
  @@map("kompetensi_user")
}

model UserStatus {
  id_user_status Int             @id @default(autoincrement())
  id_user        Int
  status         UserStatusEnum?
  id_admin       Int?
  created_at     DateTime?       @default(now()) @map("created_at")
  description    String?         @db.VarChar(45)
  user           Users           @relation("UserOwner", fields: [id_user], references: [id_user])
  admin          Users?          @relation("AdminModifier", fields: [id_admin], references: [id_user])

  @@map("user_status")
}

model Jenjang {
  id_jenjang   Int     @id @default(autoincrement())
  nama_jenjang String? @db.VarChar(45)
  keterangan   String? @db.VarChar(45)
  id_user      Int?
  creator      Users?  @relation("UserJenjang", fields: [id_user], references: [id_user])
  topics       Topics[]

  @@map("jenjang")
}

model Topics {
  id_topics   Int     @id @default(autoincrement())
  nama_topics String? @db.VarChar(45)
  keterangan  String? @db.VarChar(45)
  id_subjects Int
  id_user     Int?
  creator     Users?  @relation("UserTopics", fields: [id_user], references: [id_user])

  subject        Subjects         @relation(fields: [id_subjects], references: [id_subject])
  subTopics      SubTopics[]
  soal           Soal[]
  id_jenjang     Int
  jenjang        Jenjang          @relation(fields: [id_jenjang], references: [id_jenjang])
  categoryTopics CategoryTopics[]

  @@map("topics")
}

model CategoryTopics {
  id_topics   Int
  id_category Int
  topic       Topics     @relation(fields: [id_topics], references: [id_topics])
  category    Categories @relation(fields: [id_category], references: [id_category])

  @@id([id_topics, id_category])
  @@map("kategori_topics")
}

model SubTopics {
  id_subtopics    Int               @id @default(autoincrement())
  nama_subtopics  String?           @db.VarChar(45)
  keterangan      String?           @db.VarChar(45)
  deskripsi       String?           @db.Text
  id_topics       Int
  topic           Topics            @relation(fields: [id_topics], references: [id_topics])
  detailSubTopics DetailSubTopics[]
  id_user         Int?
  creator         Users?            @relation("UserSubTopics", fields: [id_user], references: [id_user])
  soal            Soal[]

  @@map("sub_topics")
}

model DetailSubTopics {
  id_detail_subtopics   Int       @id @default(autoincrement())
  nama_detail_subtopics String?   @db.VarChar(45)
  keterangan            String?   @db.VarChar(45)
  id_subtopics          Int
  subTopic              SubTopics @relation(fields: [id_subtopics], references: [id_subtopics])
  soal                  Soal[]

  @@map("detail_sub_topics")
}

model CategorySubject {
  id_category_subject Int        @id @default(autoincrement())
  id_category         Int        @map("d_category")
  id_subject          Int
  category            Categories @relation(fields: [id_category], references: [id_category])
  subject             Subjects   @relation(fields: [id_subject], references: [id_subject])

  @@map("category_subject")
}

model Soal {
  id_soal             Int             @id @default(autoincrement())
  tanggal_pembuatan   String?         @db.VarChar(45)
  text_soal           String?         @db.Text
  jenis_soal          JenisSoal?
  level_kesulitan     LevelKesulitan?
  id_contributor      Int
  status              StatusSoal?
  catatan_revisi      String?         @db.Text
  id_topics           Int
  id_subtopics        Int?
  id_detail_subtopics Int?

  contributor    Users            @relation("UserSoal", fields: [id_contributor], references: [id_user])
  topic          Topics           @relation(fields: [id_topics], references: [id_topics])
  subTopic       SubTopics?       @relation(fields: [id_subtopics], references: [id_subtopics])
  detailSubTopic DetailSubTopics? @relation(fields: [id_detail_subtopics], references: [id_detail_subtopics])

  soalTags    SoalTags[]
  validasi    ValidasiSoal[]
  reports     Reports[]
  favorites   Favorites[]
  soalPaket   SoalPaketSoal[]
  jawaban     JawabanSoal[]
  attachments AttachmentsSoal[]

  @@map("soal")
}

model SoalTags {
  id_tags      Int     @id @default(autoincrement())
  tag          String? @db.VarChar(45)
  soal_id_soal Int
  soal         Soal    @relation(fields: [soal_id_soal], references: [id_soal])

  @@map("soal_tags")
}

model ValidasiSoal {
  id_validasi      Int             @id @default(autoincrement())
  tanggal_validasi DateTime?
  keterangan       String?         @db.VarChar(500)
  status           StatusValidasi?
  id_validator     Int
  id_soal          Int
  validator        Users           @relation(fields: [id_validator], references: [id_user])
  soal             Soal            @relation(fields: [id_soal], references: [id_soal])

  @@map("validasi_soal")
}

model Subscribers {
  id_subscriber       Int                      @id @default(autoincrement())
  username            String?                  @db.VarChar(45)
  password            String?                  @db.VarChar(100)
  nama_subscriber     String?                  @db.VarChar(45)
  email_subscriber    String?                  @unique @db.VarChar(45)
  googleId            String?                  @unique @db.VarChar(255)
  phone               String?                  @unique @db.VarChar(45)
  foto                String?                  @db.VarChar(255)
  reports             Reports[]
  
  favorites           Favorites[]
  
  folders             Folders[]

  transaksi           Transaksi[]
  eventsDiikuti       EventSubscriber[]

  subscribePaket      SubscribePaket[]
  paketAttempt        PaketAttempt[]
  historyPengerjaan   HistoryPengerjaanPaket[]
  institusiSubscriber SubscribersInstitusi[]

  @@map("subscribers")
}

model Reports {
  id_report      Int         @id @default(autoincrement())
  id_subscriber  Int
  id_soal        Int
  keterangan     String?     @db.VarChar(500)
  tanggal_report DateTime?
  status         String?     @db.VarChar(45)
  subscriber     Subscribers @relation(fields: [id_subscriber], references: [id_subscriber])
  soal           Soal        @relation(fields: [id_soal], references: [id_soal])

  @@map("reports")
}

model Favorites {
  id_favorite   Int         @id @default(autoincrement())
  id_subscriber Int
  id_soal       Int
  tanggal       DateTime?   @default(now()) // Tambahan: default now
  
  subscriber    Subscribers @relation(fields: [id_subscriber], references: [id_subscriber])
  soal          Soal        @relation(fields: [id_soal], references: [id_soal])

  id_folder     Int?        
  folder        Folders?    @relation(fields: [id_folder], references: [id_folder], onDelete: SetNull)

  @@map("favorites")
}

model PaketSoal {
  id_paket_soal  Int             @id @default(autoincrement())
  jenis          JenisPaket?     @default(gratis)
  tanggal_dibuat DateTime?
  status         StatusPaket?
  nama_paket     String?         @db.VarChar(100)
  image          String?         @db.VarChar(255)
  deskripsi      String?         @db.Text
  jumlah_soal    Int?
  durasi         Int?
  id_category    Int?
  id_creator     Int
  category       Categories?     @relation(fields: [id_category], references: [id_category])
  creator        Users           @relation(fields: [id_creator], references: [id_user])
  soalPaket      SoalPaketSoal[]
  paketAttempt   PaketAttempt[]
  eventPaket     EventPaketSoal[]

  @@map("paket_soal")
}

model SoalPaketSoal {
  id_soal_paket_soal Int                      @id @default(autoincrement())
  id_soal            Int
  id_paket_soal      Int
  point              Float?                   @default(1)
  durasi             Int?                     @default(0)
  soal               Soal                     @relation(fields: [id_soal], references: [id_soal])
  paketSoal          PaketSoal                @relation(fields: [id_paket_soal], references: [id_paket_soal])
  history            HistoryPengerjaanPaket[]

  @@map("soal_paket_soal")
}

model Transaksi {
  id_transaksi String   @id @default(uuid()) 
  amount       Int
  status       String   @default("pending")  
  snap_token   String?  
  payment_type String?  
  created_at   DateTime @default(now())
  updated_at   DateTime @updatedAt

  id_subscriber Int
  subscriber    Subscribers @relation(fields: [id_subscriber], references: [id_subscriber])

  id_paket_langganan Int
  paketLangganan     PaketLangganan @relation(fields: [id_paket_langganan], references: [id_paket_langganan])

  @@map("transaksi")
}

model PaketLangganan {
  id_paket_langganan Int              @id @default(autoincrement())
  nama_paket         String?          @db.VarChar(45)
  harga              Int?
  masa_berlaku       Int?             @default(1)
  nama_periode       NamaPeriode?     @default(bulan)
  status             StatusPaket?     @map("status")
  id_category        Int?
  category           Categories?       @relation(fields: [id_category], references: [id_category])
  transaksi          Transaksi[]
  diskonPaket        DiskonPaket[]
  subscribes         SubscribePaket[]

  @@map("paket_langganan")
}

model DiskonPaket {
  id_diskon              Int            @id @default(autoincrement())
  diskon                 Float?         @default(0)
  tanggal_mulai_diskon   DateTime?
  tanggal_selesai_diskon DateTime?
  id_paket_langganan     Int
  paketLangganan         PaketLangganan @relation(fields: [id_paket_langganan], references: [id_paket_langganan])

  @@map("diskon_paket")
}

model SubscribePaket {
  id_subscribe       Int              @id @default(autoincrement())
  id_subscriber      Int
  id_paket_langganan Int
  tanggal_subscribe  DateTime?
  tanggal_mulai      DateTime?
  tanggal_selesai    DateTime?
  status             StatusSubscribe?
  subscriber         Subscribers      @relation(fields: [id_subscriber], references: [id_subscriber])
  paketLangganan     PaketLangganan   @relation(fields: [id_paket_langganan], references: [id_paket_langganan])

  @@map("subscribe_paket")
}

model PaketAttempt {
  id_paket_attempt          Int                      @id @default(autoincrement())
  paket_soal_id_paket_soal  Int
  subscribers_id_subscriber Int
  started_at                DateTime?
  finished_at               DateTime?
  paketSoal                 PaketSoal                @relation(fields: [paket_soal_id_paket_soal], references: [id_paket_soal])
  subscriber                Subscribers              @relation(fields: [subscribers_id_subscriber], references: [id_subscriber])
  history                   HistoryPengerjaanPaket[]

  @@map("paket_attempt")
}

model JawabanSoal {
  id_jawaban          Int                      @id @default(autoincrement())
  opsi_jawaban_text   String?                  @db.VarChar(100)
  path_gambar_jawaban String?                  @db.VarChar(255)
  status              Boolean?                 @default(false)
  short_answer        String?                  @db.VarChar(45)
  soal_id_soal        Int
  pembahasan          String?                  @db.Text
  soal                Soal                     @relation(fields: [soal_id_soal], references: [id_soal])
  history             HistoryPengerjaanPaket[]

  @@map("jawaban_soal")
}

model HistoryPengerjaanPaket {
  id_history         Int           @id @default(autoincrement())
  id_subscriber      Int
  id_soal_paket_soal Int
  id_paket_attempt   Int
  id_jawaban         Int
  tanggal            DateTime?
  short_answer       String?       @db.VarChar(45)
  skor_point         Float?
  subscriber         Subscribers   @relation(fields: [id_subscriber], references: [id_subscriber])
  soalPaketSoal      SoalPaketSoal @relation(fields: [id_soal_paket_soal], references: [id_soal_paket_soal])
  paketAttempt       PaketAttempt  @relation(fields: [id_paket_attempt], references: [id_paket_attempt])
  jawabanSoal        JawabanSoal   @relation(fields: [id_jawaban], references: [id_jawaban])

  @@map("history_pengerjaan_paket")
}

model AttachmentsSoal {
  id_attachment   Int     @id @default(autoincrement())
  path_attachment String? @db.VarChar(255)
  keterangan      String? @db.VarChar(100)
  id_soal         Int
  soal            Soal    @relation(fields: [id_soal], references: [id_soal])

  @@map("attachments_soal")
}

model InstitusiTarget {
  id_target            Int                    @id @default(autoincrement())
  nama_target          String?                @db.VarChar(100)
  subscribersInstitusi SubscribersInstitusi[]

  @@map("insitusi_target")
}

model SubscribersInstitusi {
  id_institusi_subscriber Int             @id @default(autoincrement())
  id_institusi            Int
  id_subscriber           Int
  institusi               InstitusiTarget @relation(fields: [id_institusi], references: [id_target])
  subscriber              Subscribers     @relation(fields: [id_subscriber], references: [id_subscriber])

  @@map("subscribers_insitusi")
}

model Folders {
  id_folder     Int      @id @default(autoincrement())
  nama_folder   String   @db.VarChar(100)
  keterangan    String?  @db.VarChar(255)
  created_at    DateTime @default(now())
  updated_at    DateTime @updatedAt

  id_subscriber Int
  subscriber    Subscribers @relation(fields: [id_subscriber], references: [id_subscriber])

  favorites     Favorites[]

  @@map("folders")
}
model SystemNotification {
  id_notification Int      @id @default(autoincrement())
  title           String   @db.Text 
  message         String   @db.Text 
  is_read         Boolean  @default(false)
  created_at      DateTime @default(now())

  id_recipient    Int
  recipient       Users    @relation("NotifRecipient", fields: [id_recipient], references: [id_user])
  
  id_sender       Int?
  sender          Users?   @relation("NotifSender", fields: [id_sender], references: [id_user])

  @@map("system_notifications")
}

model Event {
  id_event          Int             @id @default(autoincrement())
  nama_event        String          @db.VarChar(100)
  deskripsi         String?         @db.Text
  tanggal_mulai     DateTime
  tanggal_selesai   DateTime
  durasi_pengerjaan Int             @default(0) // Dalam menit
  banner            String?         @db.VarChar(255)
  status            StatusEvent     @default(draft)
  jenis             JenisEvent      @default(Gratis)
  created_at        DateTime        @default(now())
  updated_at        DateTime        @updatedAt

  // Relasi ke Kategori
  id_category       Int
  category          Categories      @relation(fields: [id_category], references: [id_category])

  // Relasi ke Paket Soal (Many-to-Many via pivot table)
  eventPaket        EventPaketSoal[]

  // Relasi ke Pendaftar (Subscriber) - Opsional, untuk tracking siapa yang ikut
  pendaftar         EventSubscriber[]

  @@map("events")
}

model EventPaketSoal {
  id_event_paket Int       @id @default(autoincrement())
  id_event       Int
  id_paket_soal  Int
  
  // Relasi
  event          Event     @relation(fields: [id_event], references: [id_event], onDelete: Cascade)
  paketSoal      PaketSoal @relation(fields: [id_paket_soal], references: [id_paket_soal], onDelete: Cascade)

  @@unique([id_event, id_paket_soal]) // Mencegah duplikasi paket di event yang sama
  @@map("event_paket_soal")
}

model EventSubscriber {
  id_event_subscriber Int         @id @default(autoincrement())
  id_event            Int
  id_subscriber       Int
  tanggal_daftar      DateTime    @default(now())
  
  event               Event       @relation(fields: [id_event], references: [id_event])
  subscriber          Subscribers @relation(fields: [id_subscriber], references: [id_subscriber])

  @@unique([id_event, id_subscriber]) // Satu user hanya bisa daftar 1x per event
  @@map("event_subscribers")
}